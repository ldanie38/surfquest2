<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ post.title }} â€“ SurfQuest</title>
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/index.css') }}"
  >
</head>
<body>
  <main>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flashes">
          {% for msg in messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <article class="blog-post">
      <h1>{{ post.title }}</h1>
      <p>by {{ post.author_username }}</p>
      <div>{{ post.body | safe }}</div>
    </article>

    <section class="comments-section">
      <h2>Comments</h2>

      <!-- Top-level comment form -->
      <form
        action="{{ url_for('add_comment', post_id=post.id) }}"
        method="POST"
        enctype="multipart/form-data"
        class="comment-form"
      >
        <textarea
          name="content"
          rows="3"
          placeholder="Write your commentâ€¦"
          required
        ></textarea>
        <input
          type="file"
          name="comment_image"
          accept="image/*"
        >
        <button type="submit">Post Comment</button>
      </form>

      <div class="comments-list">
        {% for comment in comments %}
          {% if not comment.parent_comment_id %}
            <div class="comment" id="comment-{{ comment.id }}">
              <p>
                <strong>{{ comment.username }}</strong>:
                {{ comment.content }}
              </p>

              {% if comment.image_url %}
                <img
                  src="{{ comment.image_url }}"
                  alt="Comment image"
                  style="max-width:200px; margin:.5em 0;"
                >
              {% endif %}

              <!-- Reply toggle -->
              <button
                type="button"
                class="reply-button"
                data-comment-id="{{ comment.id }}"
              >ðŸ’¬ Reply</button>

              <!-- Nested reply form (initially hidden) -->
              <div
                id="reply-form-{{ comment.id }}"
                class="reply-form-container"
                style="display: none; margin-top:.5em;"
              >
                <form
                  action="{{ url_for('add_comment', post_id=post.id) }}"
                  method="POST"
                  enctype="multipart/form-data"
                  class="reply-form"
                >
                  <input
                    type="hidden"
                    name="parent_comment_id"
                    value="{{ comment.id }}"
                  >
                  <textarea
                    name="content"
                    rows="2"
                    placeholder="Your replyâ€¦"
                    required
                  ></textarea>
                  <input
                    type="file"
                    name="reply_image"
                    accept="image/*"
                  >
                  <button type="submit">Post Reply</button>
                </form>
              </div>

              <div class="replies" style="margin-left: 2em;">
                {% for reply in comments %}
                  {% if reply.parent_comment_id == comment.id %}
                    <div class="reply" id="comment-{{ reply.id }}">
                      <p>
                        <strong>{{ reply.username }}</strong>:
                        {{ reply.content }}
                      </p>
                      {% if reply.image_url %}
                        <img
                          src="{{ reply.image_url }}"
                          alt="Reply image"
