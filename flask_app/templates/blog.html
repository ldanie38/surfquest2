<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surf Blog</title>
  <link rel="stylesheet" href="/static/css/blog.css">
  <link rel="stylesheet" href="https://use.typekit.net/gqv8jnv.css"> <!-- Adobe font -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon-32x32.png">
</head>
<body>
  {# Define the macro to recursively render nested comments, with "post" passed in #}
  {% macro render_comments(comments, post) %}
    <ul>
      {% for comment in comments %}
        <li>
          <p><strong>{{ comment.username }}</strong>: {{ comment.content }}</p>
          <!-- Optional button to reply to this comment -->
          <button class="reply-button" data-comment-id="{{ comment.id }}">Reply</button>
          
          <!-- Render a reply form -->
          <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
            <form class="comment-form" data-parent-id="{{ comment.id }}" action="/blog/{{ post.id }}/comment" method="POST">
              <textarea name="content" rows="2" placeholder="Your reply..." required></textarea>
              <button type="submit">Submit Reply</button>
            </form>
          </div>
          
          {# Recursively render any children comments, passing the same post object #}
          {% if comment.children %}
            {{ render_comments(comment.children, post) }}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endmacro %}

  <header>
    <div class="head">
      <h1>SurfQuest Blog</h1>
    </div>
  </header>

  <div class="container">
    <section class="create_post">
      {% if username %}
        <form action="/blog/create" method="POST">
          <p class="welcome"><h3>Share Your Story {{ username|title }}</h3></p>
          <label for="title">Big Kahuna:</label>
          <input type="text" id="title" name="title" required>
          
          <label for="content">Swell Details:</label>
          <textarea id="content" name="content" rows="5" required maxlength="5000"></textarea>
          
          <button type="submit">DropIn</button>
        </form>
      {% endif %}
      <div class="create_post_image">
        <img id="surfImage" src="/static/img/bad_ass.jpg" alt="Surfboard on the beach">
      </div>
      <div class="logout">
        <a href="/home">Back to Home</a> | 
        <a href="/logout">Logout</a>
      </div>
    </section>

    <hr>

    <section class="blog_post">
      {% for post in posts %}
        <article>
          <div class="post_show">
            <h3>{{ post.title }}</h3>
            <p>{{ post.content }}</p>
            <p>
              <strong>By:</strong> {{ post.author_username }} | 
              {{ post.created_at.strftime('%Y-%m-%d') }}
            </p>
          </div>

          <div class="likes_comment">
            <!-- Like Button -->
            <p>
              <button class="like-button" data-post-id="{{ post.id }}">
                ‚ù§Ô∏è Like (<span class="like-count">{{ post.likes }}</span>)
              </button>
            </p>
            
            <!-- Comment Button -->
            <p>
              <button class="comment-button" data-post-id="{{ post.id }}">
                üí¨ Comment
              </button>
            </p>
          </div>

          <div class="comment_container">
            <!-- Display nested comments using our macro -->
            <div id="comments-container-{{ post.id }}" style="display: none;">
              {{ render_comments(post_comments[post.id], post) }}
            </div>
            <!-- Comment Form -->
            <div id="comment-form-{{ post.id }}" class="comment-form" style="display: none;">
              <form class="comment-form" data-post-id="{{ post.id }}" action="/blog/{{ post.id }}/comment" method="POST">
                <input type="hidden" name="post_id" value="{{ post.id }}">
                <label for="comment-content-{{ post.id }}"></label>
                <textarea id="comment-content-{{ post.id }}" name="content" rows="3" placeholder="Write your comment..." required></textarea>
                <button type="submit">Post Comment</button>
              </form>
            </div>
          </div>
        </article>
        <hr>
      {% endfor %}
    </section>
  </div>

  <!-- Back to Top Arrow -->
  <div id="backToTop" class="back-to-top">‚ñ≤</div>

  <footer>
    <p>&copy; Catch The Latest Waves</p>
  </footer>

  <script src="/static/blog.js"></script>
</body>
</html>
